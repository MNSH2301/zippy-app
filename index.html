<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>Zippy Stock — 3 Page Flow</title>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<style>
  :root{ --bg:#0f1113; --card:#15181b; --ink:#ffffff; --muted:#98a2b3; --line:#27313a; --pill:#1b2025; --accent:#00d19a; }
  *{ box-sizing:border-box; -webkit-tap-highlight-color:transparent }
  html,body{ height:100% }
  body{ margin:0; background:var(--bg); color:var(--ink); font-family: system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; }
  .wrap{ max-width:1060px; margin:0 auto; padding:12px 16px }
  header{ position:sticky; top:0; z-index:30; backdrop-filter: blur(8px); background:rgba(15,17,19,.7); border-bottom:1px solid var(--line) }
  h1{ font-size:18px; margin:0; display:flex; align-items:center; gap:10px }
  .brand{ height:34px;width:34px;border-radius:10px;background:#111;color:#fff;display:grid;place-items:center;font-weight:800 }
  .muted{ color:var(--muted) }
  .btn{ border:1px solid var(--line); background:var(--card); color:var(--ink); padding:10px 14px; border-radius:12px; font-weight:600; cursor:pointer }
  .btn.primary{ background:linear-gradient(180deg,var(--accent),#00b485); color:#041d15; border:none }
  .btn.danger{ border-color:#7f1d1d; color:#fecaca }
  .input, select{ border:1px solid var(--line); background:var(--card); color:var(--ink); padding:10px 12px; border-radius:12px; width:100%; font-size:16px }
  .card{ background:var(--card); border:1px solid var(--line); border-radius:16px; padding:14px }
  .grid{ display:grid; gap:12px }
  .chips{ display:flex; gap:8px; flex-wrap:wrap }
  .chip{ display:inline-flex; align-items:center; gap:8px; padding:6px 10px; border-radius:999px; background:var(--pill); border:1px solid var(--line); font-size:12px }
  .hid{ display:none }
  .page{ display:none }
  .page.active{ display:block }
  .deck-controls{ display:grid; gap:10px; grid-template-columns: 1fr auto; align-items:center }
  .deck{ display:grid; gap:12px; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); }
  .dcard{ border:1px solid var(--line); background:var(--card); border-radius:14px; overflow:hidden; text-align:left; cursor:pointer }
  .dcard img{ width:100%; height:120px; object-fit:cover; display:block; background:#0b0d10 }
  .dcard .body{ padding:10px 12px; display:grid; gap:6px }
  .dname{ font-weight:700; font-size:15px }
  .dsub{ font-size:12px; color:var(--muted) }
  table{ border-collapse:collapse; width:100% }
  th,td{ border-bottom:1px solid var(--line); text-align:left; padding:8px; font-size:14px }
  td input[type="number"]{ width:100%; border:1px solid var(--line); background:var(--bg); color:var(--ink); border-radius:8px; padding:6px 8px; font-size:14px; -moz-appearance:textfield; }
  input::-webkit-outer-spin-button, input::-webkit-inner-spin-button{ -webkit-appearance: none; margin: 0; }
  .party-list{ display:grid; gap:10px }
  .party-item{ border:1px solid var(--line); background:var(--card); border-radius:14px; padding:12px; display:flex; justify-content:space-between; align-items:center; cursor:pointer }
  .party-item .title{ font-weight:650; font-size:15px }
  .p2img{ max-width:100%; max-height:220px; border-radius:12px; border:1px solid var(--line); object-fit:cover }
</style>
</head>
<body>
<header>
  <div class="wrap" style="display:flex;justify-content:space-between;align-items:center;gap:10px;">
    <h1><span class="brand">Z</span> Zippy Stock</h1>
    <div class="grid" style="grid-auto-flow:column;gap:8px;align-items:center;">
      <button id="btnUpload" class="btn">Upload Excel</button>
      <input id="file" type="file" accept=".xlsx,.xls" style="display:none" />
      <button id="btnSaveSnap" class="btn">Save snapshot</button>
      <input id="snapLoad" type="file" accept=".json" style="display:none" />
      <button id="btnLoadSnap" class="btn">Load snapshot</button>
    </div>
  </div>
</header>

<main class="wrap">
  <!-- PAGE 1 -->
  <section id="page1" class="page active grid">
    <div class="card deck-controls">
      <input id="searchDesign" class="input" placeholder="Search design…" />
      <div class="chips" style="justify-self:end">
        <span class="chip"><b>Total Lot</b> <span id="totLot">0</span></span>
        <span class="chip"><b>Total Ready</b> <span id="totReady">0</span></span>
      </div>
    </div>
    <div id="designDeck" class="deck"></div>
    <div id="emptyDesigns" class="card muted">Upload an Excel file to see designs.</div>
  </section>

  <!-- PAGE 2 -->
  <section id="page2" class="page grid">
    <div class="grid" style="grid-auto-flow:column; gap:8px; align-items:center;">
      <button id="backTo1" class="btn">← Designs</button>
      <h2 id="p2title" style="margin:0;font-size:16px"></h2>
    </div>

    <div class="card grid">
      <img id="p2img" class="p2img hid" alt="" />
      <div class="grid" style="grid-template-columns: 1fr auto auto auto; gap:8px; align-items:center;">
        <input id="p2imgUrl" class="input" placeholder="Paste design image URL (or use Upload)" />
        <button id="p2saveImgUrl" class="btn">Save</button>
        <button id="p2uploadImgBtn" class="btn">Upload</button>
        <button id="p2clearImg" class="btn danger">Remove</button>
        <input id="p2uploadImg" type="file" accept="image/*" class="hid" />
      </div>
    </div>

    <div class="card grid">
      <div class="chips" id="p2chips">
        <span class="chip"><b>Lot Σ</b> <span id="p2Lot">0</span></span>
        <span class="chip"><b>Ready Σ</b> <span id="p2Ready">0</span></span>
        <span class="chip"><b>Dispatched Σ</b> <span id="p2D">0</span></span>
        <span class="chip"><b>Bal (L−D)</b> <span id="p2BL">0</span></span>
        <span class="chip"><b>Bal (R−D)</b> <span id="p2BR">0</span></span>
      </div>
    </div>

    <div class="card grid">
      <div style="display:flex;justify-content:space-between;align-items:center;">
        <h3 style="margin:0">Lot Stock (editable)</h3>
        <button id="saveLot" class="btn primary">Save Lot</button>
      </div>
      <div id="lotTable"></div>
    </div>

    <div class="card grid">
      <div style="display:flex;justify-content:space-between;align-items:center;">
        <h3 style="margin:0">Ready Stock (editable)</h3>
        <button id="saveReady" class="btn primary">Save Ready</button>
      </div>
      <div id="readyTable"></div>
    </div>

    <div class="card grid">
      <div style="display:flex;justify-content:space-between;align-items:center;">
        <h3 style="margin:0">Parties (Dispatched)</h3>
        <input id="partySearch2" class="input" placeholder="Search party…" style="max-width:260px" />
      </div>
      <div id="partyList2" class="party-list"></div>
      <div id="emptyParties" class="muted">No dispatched rows for this design yet.</div>
    </div>
  </section>

  <!-- PAGE 3 -->
  <section id="page3" class="page grid">
    <div class="grid" style="grid-auto-flow:column; gap:8px; align-items:center;">
      <button id="backTo2" class="btn">← Design</button>
      <h2 id="p3title" style="margin:0;font-size:16px"></h2>
    </div>
    <div class="card grid">
      <div id="partyDetail"></div>
    </div>
  </section>
</main>

<script>
/* ===== Shortcuts & State ===== */
const $ = (id)=>document.getElementById(id);
const fileEl=$('file'), btnUpload=$('btnUpload'),
      btnSaveSnap=$('btnSaveSnap'), btnLoadSnap=$('btnLoadSnap'), snapLoad=$('snapLoad');
const page1=$('page1'), page2=$('page2'), page3=$('page3');
const designDeck=$('designDeck'), emptyDesigns=$('emptyDesigns'), searchDesign=$('searchDesign');
const totLot=$('totLot'), totReady=$('totReady');
const p2title=$('p2title'), p2Lot=$('p2Lot'), p2Ready=$('p2Ready'), p2D=$('p2D'), p2BL=$('p2BL'), p2BR=$('p2BR'),
      lotTable=$('lotTable'), readyTable=$('readyTable'), partyList2=$('partyList2'), emptyParties=$('emptyParties'),
      partySearch2=$('partySearch2'), backTo1=$('backTo1'), backTo2=$('backTo2');
const p3title=$('p3title'), partyDetail=$('partyDetail');
const p2img=$('p2img'), p2imgUrl=$('p2imgUrl'), p2saveImgUrl=$('p2saveImgUrl'), p2uploadImgBtn=$('p2uploadImgBtn'),
      p2uploadImg=$('p2uploadImg'), p2clearImg=$('p2clearImg');

let SHEET_ORDER=[], DESIGNS={}, SIZE_LABELS={}, IMAGES={};
try{ IMAGES=JSON.parse(localStorage.getItem('zippyDesignImages')||'{}'); }catch{ IMAGES={}; }
let CUR_DESIGN="", CUR_PARTY="";

/* ===== Utilities ===== */
const sanitize=(v)=>v==null?"":String(v).trim();
function numVal(v){ if(typeof v==='number'&&Number.isFinite(v))return v;
  if(typeof v==='string'){const s=v.trim().replaceAll(',',''); if(['','-','–','—','.'].includes(s))return 0; const n=Number(s); return Number.isFinite(n)?n:null;}
  return null;
}
function addTo(map,c,s,q){ (map[c]||(map[c]={}))[s]=(map[c][s]||0)+q; }
function sumTotals(map){ let t=0; for(const c in map){ for(const s in map[c]) t+=map[c][s]||0;} return t;}
function sizeOrder(a,b){ const A=a.toLowerCase(),B=b.toLowerCase();
  if(A==='free size'&&B!=='free size')return 1; if(B==='free size'&&A!=='free size')return -1;
  const an=parseInt(A.replace(/\D/g,''),10), bn=parseInt(B.replace(/\D/g,''),10);
  if(!Number.isNaN(an)&&!Number.isNaN(bn)) return an-bn; return A.localeCompare(B);
}
function escapeHtml(s){ return String(s).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;').replaceAll('"','&quot;'); }

/* ===== Canon helpers ===== */
const TOTAL_LIKE  = /total|grand\s*total|amount|net|sum/i;
function canonSize(s){
  let t=sanitize(s).toLowerCase();
  if(!t) return '';
  if(TOTAL_LIKE.test(t)) return '';
  t = t.replace(/\s*\/\s*/g,'/').replace(/\s*-\s*/g,'/').replace(/\s+/g,' ').trim();
  if(t==='fs'||t==='free size') return 'Free Size';
  return t.toUpperCase();
}
function isNumericDesignHeader(token){
  const t=sanitize(token);
  if(!t) return false;
  return /^\d{3,}$/.test(t); // e.g., "4610"
}
const IGNORED_COLOR_TOKENS=new Set(['status','party','amount','rate','gst','hsn','invoice','bill','mrp','price','qty','quantity','net','sum','total','grand total']);
function normalizeColorToken(token, sheetName){
  let t=sanitize(token);
  if(!t) return '';
  const lower=t.toLowerCase();
  if(IGNORED_COLOR_TOKENS.has(lower)) return '';
  if(isNumericDesignHeader(t)) return '__NUMERIC__'; // mark numeric colour header
  if(lower===sanitize(sheetName).toLowerCase()) return '';
  if(TOTAL_LIKE.test(lower)) return '';
  return t;
}

/* ===== Navigation ===== */
function go(p){ page1.classList.remove('active'); page2.classList.remove('active'); page3.classList.remove('active'); (p===1?page1:p===2?page2:page3).classList.add('active'); window.scrollTo({top:0,behavior:'instant'}); }
backTo1.addEventListener('click',()=>go(1),{passive:true});
backTo2.addEventListener('click',()=>go(2),{passive:true});

/* ===== Excel Upload ===== */
btnUpload.addEventListener('click',()=>fileEl.click(),{passive:true});
fileEl.addEventListener('change', async (e)=>{
  const f=e.target.files?.[0]; if(!f) return;
  const buf=await f.arrayBuffer();
  const wb=XLSX.read(buf,{type:'array'});
  loadWorkbook(wb);
},{passive:true});

/* ===== Snapshot save/load ===== */
btnSaveSnap.addEventListener('click',()=>{
  const payload={sheetOrder:SHEET_ORDER, designs:DESIGNS, sizeLabels:SIZE_LABELS, ts:new Date().toISOString()};
  const blob=new Blob([JSON.stringify(payload)],{type:'application/json'});
  const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='zippy-snapshot.json'; a.click(); URL.revokeObjectURL(a.href);
},{passive:true});
btnLoadSnap.addEventListener('click',()=>snapLoad.click(),{passive:true});
snapLoad.addEventListener('change', async (e)=>{
  const f=e.target.files?.[0]; if(!f) return; const text=await f.text(); const data=JSON.parse(text);
  applySnapshot(data);
},{passive:true});

/* ===== Workbook Parsing ===== */
const lotRe=/^lot(\s*\d+)?$/i, readyRe=/^ready(\s*\d+)?$/i, rateRe=/^rate(\b|$)/i;

function isDispatchedMark(v){
  const t=sanitize(v).toLowerCase();
  if(!t) return false;
  if(t==='d') return true;
  if(/^d(isp|ispt|ispatch|ispatched)?/.test(t)) return true;
  if(t==='y'||t==='yes'||t==='1') return true;
  if(t==='✓'||t==='✔') return true;
  return false;
}
function detectStatusCol(aoa){
  const h0=(aoa[0]||[]).map(sanitize), h1=(aoa[1]||[]).map(sanitize);
  const ncols=Math.max(h0.length,h1.length);
  const isStatusHeader=(s)=>/^\s*status\s*:?\s*$/i.test(s||'');
  for(let c=0;c<ncols;c++){ if(isStatusHeader(h0[c]) || isStatusHeader(h1[c])) return c; }
  // heuristic fallback
  let bestCol=1, bestScore=-1;
  const maxRows=Math.min(aoa.length, 200);
  for(let c=0;c<ncols;c++){
    let score=0, dcount=0;
    for(let r=2;r<maxRows;r++){
      const v=(aoa[r]||[])[c];
      if(isDispatchedMark(v)){ score+=2; dcount++; continue; }
      const n=numVal(v);
      if(n!==null && n!==0) score-=2;
      else if(sanitize(v)!=='') score-=1;
    }
    if(dcount>=2 && score>bestScore){ bestScore=score; bestCol=c; }
  }
  return bestCol;
}

function loadWorkbook(wb){
  DESIGNS={}; SHEET_ORDER=[]; SIZE_LABELS={};
  for(const name of wb.SheetNames){
    if(String(name).toUpperCase()==="PARTY LIST") continue;
    const ws=wb.Sheets[name];
    const aoa=XLSX.utils.sheet_to_json(ws,{header:1,raw:true,defval:null});
    if(!aoa||!aoa.length) continue;
    const parsed=parseDesignSheet(name,aoa);
    DESIGNS[name]=parsed.data; SIZE_LABELS[name]=parsed.sizeLabels; SHEET_ORDER.push(name);
  }
  renderPage1();
}

function parseDesignSheet(name, aoa){
  const h0=(aoa[0]||[]).map(sanitize), h1=(aoa[1]||[]).map(sanitize), ncols=Math.max(h0.length,h1.length);
  const statusCol = detectStatusCol(aoa);

  // Build raw column map with flags
  const rawColMap=[];
  for(let c=2;c<ncols;c++){
    let head0=sanitize(h0[c]); // colour-ish
    let head1=sanitize(h1[c]); // size-ish
    if(!head0 && !head1) continue;
    if(TOTAL_LIKE.test(head0) || TOTAL_LIKE.test(head1)) continue;

    let color='', size='';
    if(head0 && !head1){
      // single line header; may contain size inside
      const m=head0.match(/(\d+\s*\/\s*\d+|\d+\s*-\s*\d+|\d+\s*to\s*\d+)/i);
      if(m){ size=canonSize(m[0]); head0=head0.replace(m[0],''); }
      else if(canonSize(head0)) { size=canonSize(head0); }
      color = normalizeColorToken(head0, name);
      if(!size) size='Free Size';
    } else if(!head0 && head1){
      if(canonSize(head1)) size=canonSize(head1); else { color = normalizeColorToken(head1, name); size='Free Size'; }
    } else {
      color = normalizeColorToken(head0, name);
      size  = canonSize(head1) || 'Free Size';
    }

    const numericColor = (color==='__NUMERIC__');
    if(numericColor) color=''; // keep empty but remember numeric flag
    size = canonSize(size);
    rawColMap.push({col:c, color, size, numericColor});
  }

  // If everything was numeric/blank → treat as single-colour sheet
  let filtered = rawColMap.filter(m => !m.numericColor);
  if(filtered.length===0 && rawColMap.length>0){
    // keep one set: convert numeric columns to Default Color
    filtered = rawColMap.map(m => ({...m, color:'', numericColor:false}));
  }

  // Decide colour behaviour on cleaned set
  const explicitColors = new Set(
    filtered.map(m=>sanitize(m.color)).filter(x=>!!x && x.toLowerCase()!=='default color')
  );
  const blankColorReplacement = (explicitColors.size<=1) ? 'Default Color' : '-';

  // Final col map + hard de-dup by canonical (color,size)
  const seen = new Set();
  const colMap = [];
  for(const m of filtered){
    const clr = m.color ? m.color : blankColorReplacement;
    const key = `${clr.toUpperCase()}__${m.size}`;
    if(seen.has(key)) continue;        // prevent double counting
    seen.add(key);
    colMap.push({col:m.col, color:clr, size:m.size});
  }

  // Parse rows
  const entries=[], lots={}, ready={}, dispatchedTotals={};
  let lastLabel="";
  for(let r=2;r<aoa.length;r++){
    const row=aoa[r]||[], raw=sanitize(row[0]), label=raw||lastLabel; if(label) lastLabel=label; if(!label) continue;
    if(rateRe.test(label)) continue;

    if(lotRe.test(label)){
      for(const {col,color,size} of colMap){ const v=numVal(row[col]); if(v!==null) addTo(lots,color,size,v); }
      continue;
    }
    if(readyRe.test(label)){
      for(const {col,color,size} of colMap){ const v=numVal(row[col]); if(v!==null) addTo(ready,color,size,v); }
      continue;
    }

    const status = isDispatchedMark(row[statusCol]) ? 'D' : '';
    for(const {col,color,size} of colMap){
      const v=numVal(row[col]); if(v===null||v===0) continue;
      entries.push({ design:name, party:label, status, color, size, qty:v });
      if(status==='D') addTo(dispatchedTotals,color,size,v);
    }
  }

  // Balances
  const balanceLot={}, balanceReady={}, colorSet=new Set([...Object.keys(lots),...Object.keys(ready),...Object.keys(dispatchedTotals),...colMap.map(m=>m.color)]);
  for(const color of colorSet){
    const sizeSet=new Set([...(lots[color]?Object.keys(lots[color]):[]), ...(ready[color]?Object.keys(ready[color]):[]), ...(dispatchedTotals[color]?Object.keys(dispatchedTotals[color]):[]), ...colMap.filter(m=>m.color===color).map(m=>m.size)]);
    for(const size of sizeSet){
      const L=lots[color]?.[size]||0, R=ready[color]?.[size]||0, D=dispatchedTotals[color]?.[size]||0;
      (balanceLot[color]||(balanceLot[color]={}))[size]=L-D;
      (balanceReady[color]||(balanceReady[color]={}))[size]=R-D;
    }
  }

  return {
    data:{ sheetName:name, entries, lots, ready, dispatchedTotals, balanceLot, balanceReady },
    sizeLabels:[...new Set(colMap.map(m=>m.size))].sort(sizeOrder)
  };
}

/* ===== Snapshot apply ===== */
function applySnapshot(data){
  SHEET_ORDER=data.sheetOrder||[]; DESIGNS=data.designs||{}; SIZE_LABELS=data.sizeLabels||{};
  CUR_DESIGN=""; CUR_PARTY="";
  renderPage1();
}

/* ===== Page 1 (deck) ===== */
searchDesign.addEventListener('input', renderPage1, {passive:true});
function renderPage1(){
  let list=SHEET_ORDER.slice();
  const q=searchDesign.value.trim().toLowerCase();
  if(q) list=list.filter(n=>n.toLowerCase().includes(q));

  let aggLot=0, aggReady=0;
  for(const name of SHEET_ORDER){
    aggLot+=sumTotals(DESIGNS[name]?.lots||{});
    aggReady+=sumTotals(DESIGNS[name]?.ready||{});
  }
  totLot.textContent=String(aggLot);
  totReady.textContent=String(aggReady);

  if(!list.length){
    designDeck.innerHTML='';
    emptyDesigns.classList.remove('hid');
  }else{
    emptyDesigns.classList.add('hid');
    designDeck.innerHTML = list.map(name=>{
      const d=DESIGNS[name]||{};
      const lotSum   = sumTotals(d.lots||{});
      const readySum = sumTotals(d.ready||{});
      const img = IMAGES[name] || '';
      return `<button class="dcard" data-name="${escapeHtml(name)}" title="Open ${escapeHtml(name)}">
        <img src="${img?escapeHtml(img):''}" alt="" onerror="this.style.display='none'">
        <div class="body">
          <div class="dname">${escapeHtml(name)}</div>
          <div class="dsub">Stock: ${readySum}</div>
          <div class="chips">
            <span class="chip">Lot ${lotSum}</span>
            <span class="chip">Ready ${readySum}</span>
          </div>
        </div>
      </button>`;
    }).join('');
    document.querySelectorAll('.dcard').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        CUR_DESIGN=btn.getAttribute('data-name');
        renderPage2();
        go(2);
      }, {passive:true});
    });
  }
}

/* ===== Helpers for editable tables ===== */
function uniqueSizesForDesign(name){
  const lbls = SIZE_LABELS[name] || [];
  if(lbls.length) return lbls;
  const d=DESIGNS[name]; const set=new Set();
  for(const map of [d.lots,d.ready,d.dispatchedTotals]){ for(const c in map){ for(const s in map[c]) set.add(s); } }
  return [...set].sort(sizeOrder);
}
function colorsForDesign(name){
  const d=DESIGNS[name]; const set=new Set();
  for(const map of [d.lots,d.ready,d.dispatchedTotals]){ for(const c in map){ set.add(c); } }
  const all=[...set].sort();
  const nonDefault = all.filter(c => c.toLowerCase()!=="default color");
  return nonDefault.length ? nonDefault : (all.length ? all : ['Default Color']);
}

function buildEditableTable(kind, totalsMap){
  const sizes=uniqueSizesForDesign(CUR_DESIGN);
  const colors=colorsForDesign(CUR_DESIGN);
  const head = `<tr><th>Color</th>${sizes.map(s=>`<th>${escapeHtml(s)}</th>`).join('')}</tr>`;
  const rows = colors.map(color=>{
    const cells=sizes.map(sz=>{
      const v= (totalsMap[color]||{})[sz] || 0;
      return `<td><input type="number" step="1" min="0" value="${v}" data-kind="${kind}" data-color="${escapeHtml(color)}" data-size="${escapeHtml(sz)}"></td>`;
    }).join('');
    return `<tr><td>${escapeHtml(color)}</td>${cells}</tr>`;
  }).join('');
  return `<div class="card"><div class="muted" style="font-size:12px">Edit values and press “Save ${kind[0].toUpperCase()+kind.slice(1)}”.</div>
          <table><thead>${head}</thead><tbody>${rows}</tbody></table></div>`;
}
function collectEdits(kind){
  const inputs=[...document.querySelectorAll(`input[data-kind="${kind}"]`)];
  const out={};
  for(const inp of inputs){
    const color=inp.getAttribute('data-color'), size=inp.getAttribute('data-size');
    const val = Number(inp.value||0);
    (out[color]||(out[color]={}))[size]=val;
  }
  return out;
}
function saveLotEdits(){
  const d=DESIGNS[CUR_DESIGN]; if(!d) return;
  d.lots = collectEdits('lot');
  recomputeBalances(CUR_DESIGN);
  renderPage2(); renderPage1();
}
function saveReadyEdits(){
  const d=DESIGNS[CUR_DESIGN]; if(!d) return;
  d.ready = collectEdits('ready');
  recomputeBalances(CUR_DESIGNS);
}
function recomputeBalances(name){
  const d=DESIGNS[name]; if(!d) return;
  const colors=new Set([...Object.keys(d.lots),...Object.keys(d.ready),...Object.keys(d.dispatchedTotals)]);
  d.balanceLot={}; d.balanceReady={};
  for(const color of colors){
    const sizes=new Set([...(d.lots[color]?Object.keys(d.lots[color]):[]), ...(d.ready[color]?Object.keys(d.ready[color]):[]), ...(d.dispatchedTotals[color]?Object.keys(d.dispatchedTotals[color]):[])]);
    for(const sz of sizes){
      const L=d.lots[color]?.[sz]||0, R=d.ready[color]?.[sz]||0, D=d.dispatchedTotals[color]?.[sz]||0;
      (d.balanceLot[color]||(d.balanceLot[color]={}))[sz] = L - D;
      (d.balanceReady[color]||(d.balanceReady[color]={}))[sz] = R - D;
    }
  }
}

/* ===== Page 2 (design) ===== */
partySearch2.addEventListener('input', renderParties, {passive:true});
$('saveLot').addEventListener('click', saveLotEdits, {passive:true});
$('saveReady').addEventListener('click', ()=>{
  const d=DESIGNS[CUR_DESIGN]; if(!d) return;
  d.ready = collectEdits('ready');
  recomputeBalances(CUR_DESIGN); renderPage2(); renderPage1();
},{passive:true});

/* per-design image controls */
function showDesignImage(){
  const url=IMAGES[CUR_DESIGN];
  if(url){ p2img.src=url; p2img.classList.remove('hid'); }
  else { p2img.removeAttribute('src'); p2img.classList.add('hid'); }
}
p2saveImgUrl.addEventListener('click',()=>{
  const url=p2imgUrl.value.trim(); if(!CUR_DESIGN){ alert('Select a design first.'); return; }
  if(!url){ alert('Paste an image URL first.'); return; }
  IMAGES[CUR_DESIGN]=url; localStorage.setItem('zippyDesignImages', JSON.stringify(IMAGES));
  p2imgUrl.value=''; showDesignImage(); renderPage1();
},{passive:true});
p2uploadImgBtn.addEventListener('click',()=>p2uploadImg.click(),{passive:true});
p2uploadImg.addEventListener('change', (e)=>{
  const f=e.target.files?.[0]; if(!f) return; if(!CUR_DESIGN){ alert('Select a design first.'); return; }
  const reader=new FileReader();
  reader.onload=()=>{ IMAGES[CUR_DESIGN]=reader.result; localStorage.setItem('zippyDesignImages', JSON.stringify(IMAGES)); showDesignImage(); renderPage1(); };
  reader.readAsDataURL(f);
},{passive:true});
p2clearImg.addEventListener('click',()=>{
  if(!CUR_DESIGN) return; delete IMAGES[CUR_DESIGN]; localStorage.setItem('zippyDesignImages', JSON.stringify(IMAGES)); showDesignImage(); renderPage1();
},{passive:true});

function renderPage2(){
  const data=DESIGNS[CUR_DESIGN]; if(!data) return;
  p2title.textContent = `Design ${CUR_DESIGN}`;
  showDesignImage();

  p2Lot.textContent = sumTotals(data.lots);
  p2Ready.textContent = sumTotals(data.ready);
  p2D.textContent = sumTotals(data.dispatchedTotals);
  p2BL.textContent = sumTotals(data.balanceLot);
  p2BR.textContent = sumTotals(data.balanceReady);

  lotTable.innerHTML = buildEditableTable('lot', data.lots);
  readyTable.innerHTML = buildEditableTable('ready', data.ready);

  renderParties();
}

/* Parties on Page 2 */
function renderParties(){
  const d=DESIGNS[CUR_DESIGN]; if(!d) return;
  const q=partySearch2.value.trim().toLowerCase();
  const entries=d.entries.filter(e=>e.status==='D');
  const map=new Map();
  for(const r of entries){ if(q && !r.party.toLowerCase().includes(q)) continue; (map.get(r.party)||map.set(r.party,[]).get(r.party)).push(r); }

  if(!entries.length){ emptyParties.style.display='block'; partyList2.innerHTML=''; return; }
  emptyParties.style.display = map.size? 'none':'block';

  const sizes = uniqueSizesForDesign(CUR_DESIGN);
  partyList2.innerHTML = [...map.entries()].sort((a,b)=>a[0].localeCompare(b[0])).map(([party,list])=>{
    const totals={}; for(const r of list){ totals[r.size]=(totals[r.size]||0)+r.qty; }
    const summary = sizes.length? sizes.map(sz=>totals[sz]||0).join(' / ')
                                : Object.values(totals).reduce((a,b)=>a+b,0);
    return `<button class="party-item" data-party="${escapeHtml(party)}">
      <span class="title">${escapeHtml(party)}</span>
      <span class="chip">${summary}</span>
    </button>`;
  }).join('');

  document.querySelectorAll('.party-item').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      CUR_PARTY = btn.getAttribute('data-party');
      renderPage3();
      go(3);
    }, {passive:true});
  });
}

/* ===== Page 3 ===== */
function renderPage3(){
  const d=DESIGNS[CUR_DESIGN]; if(!d) return;
  p3title.textContent = `Design ${CUR_DESIGN} • ${CUR_PARTY}`;

  const base=d.entries.filter(e=>e.status==='D' && e.party===CUR_PARTY);
  if(!base.length){ partyDetail.innerHTML='<div class="muted">No rows.</div>'; return; }
  const rows=base.map(r=>`<tr><td>${escapeHtml(r.color)}</td><td>${escapeHtml(r.size)}</td><td>${r.qty}</td></tr>`).join('');
  partyDetail.innerHTML = `<table><thead><tr><th>Color</th><th>Size</th><th>Qty</th></tr></thead><tbody>${rows}</tbody></table>`;
}
</script>
</body>
</html>
