<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Zippy Stock — Light Theme</title>

  <!-- PWA manifest + service worker -->
  <link rel="manifest" href="manifest.webmanifest">
  <meta name="theme-color" content="#ffffff">
  <link rel="apple-touch-icon" href="icons/icon-192.png">
  <script>
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('./sw.js');
    }
  </script>

  <!-- Light Theme Overrides -->
  <style>
    :root{
      --bg:#ffffff;
      --card:#ffffff;
      --ink:#000000;
      --muted:#444;
      --line:#e5e7eb;
      --pill:#f3f4f6;
      --accent:#0ea5e9;
    }
    body {
      background:#fff;
      color:#000;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      margin:0;
    }
    header {
      background:rgba(255,255,255,.9);
      border-bottom:1px solid var(--line);
      padding:10px;
      display:flex;
      justify-content:space-between;
      align-items:center;
    }
    h1 { font-size:18px; margin:0; }
    .btn {
      background:#f8fafc;
      color:#000;
      border:1px solid #d1d5db;
      padding:6px 12px;
      border-radius:8px;
      cursor:pointer;
    }
    .btn.primary {
      background:linear-gradient(180deg,#22c55e,#16a34a);
      color:#fff;
      border:none;
    }
    .wrap, .deck, .card, .dcard, .table, .panel {
      background:#fff !important;
      color:#000 !important;
    }
    th,td { color:#000 !important; border-bottom:1px solid var(--line); }
    input,select,textarea {
      background:#fff;
      color:#000;
      border:1px solid #d1d5db;
    }
  </style>

  <!-- Compression library for sync -->
  <script src="https://cdn.jsdelivr.net/npm/lz-string@1.5.0/libs/lz-string.min.js"></script>

  <!-- XLSX parser -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
</head>
<body>

  <header>
    <h1>Zippy Stock</h1>
    <div>
      <button id="btnUpload" class="btn">Upload Excel</button>
      <input id="file" type="file" accept=".xlsx,.xls" style="display:none" />
      <button id="btnSaveSnap" class="btn">Save snapshot</button>
      <input id="snapLoad" type="file" accept=".json" style="display:none" />
      <button id="btnLoadSnap" class="btn">Load snapshot</button>
      <button id="btnShareLink" class="btn">Get link (sync)</button>
    </div>
  </header>

  <main class="wrap">
    <!-- Page 1 -->
    <section id="page1" class="page active grid">
      <div id="designDeck" class="deck"></div>
      <div id="emptyDesigns" class="card muted">Upload an Excel file to see designs.</div>
    </section>

    <!-- Page 2 -->
    <section id="page2" class="page grid"></section>

    <!-- Page 3 -->
    <section id="page3" class="page grid"></section>
  </main>

  <script>
  /* ------------------------------------------------------------
     Core App Logic (trimmed to essentials for this demo)
     You already had full logic for parsing Excel etc — paste it here.
     I only show key parts to demonstrate where sync fits in.
  ------------------------------------------------------------ */

  let SHEET_ORDER=[], DESIGNS={}, SIZE_LABELS={};

  // Excel upload
  document.getElementById('btnUpload').addEventListener('click',()=>file.click());
  file.addEventListener('change', async e=>{
    const f=e.target.files?.[0]; if(!f) return;
    const buf=await f.arrayBuffer();
    const wb=XLSX.read(buf,{type:'array'});
    // TODO: call your parse + loadWorkbook here
    alert("Excel uploaded — parsed and stored.");
  });

  // Snapshot save
  btnSaveSnap.addEventListener('click',()=>{
    const payload={sheetOrder:SHEET_ORDER, designs:DESIGNS, sizeLabels:SIZE_LABELS};
    const blob=new Blob([JSON.stringify(payload)],{type:'application/json'});
    const a=document.createElement('a');
    a.href=URL.createObjectURL(blob); a.download='zippy-snapshot.json'; a.click();
  });

  // Snapshot load
  btnLoadSnap.addEventListener('click',()=>snapLoad.click());
  snapLoad.addEventListener('change', async e=>{
    const f=e.target.files?.[0]; if(!f) return;
    const text=await f.text();
    const data=JSON.parse(text);
    applySnapshot(data);
  });

  // Apply snapshot
  function applySnapshot(data){
    SHEET_ORDER=data.sheetOrder||[];
    DESIGNS=data.designs||{};
    SIZE_LABELS=data.sizeLabels||{};
    alert("Snapshot applied from link or file.");
  }

  /* ------------ Cross-device share link sync ------------ */
  function makeShareLink(){
    const payload = {
      sheetOrder: SHEET_ORDER,
      designs: DESIGNS,
      sizeLabels: SIZE_LABELS,
      ts: new Date().toISOString()
    };
    const json = JSON.stringify(payload);
    const encoded = LZString.compressToEncodedURIComponent(json);
    const url = location.origin + location.pathname + '#data=' + encoded;
    navigator.clipboard?.writeText(url).catch(()=>{});
    alert("Link ready and copied! Open on phone:\n\n" + url);
  }
  document.getElementById('btnShareLink').addEventListener('click', makeShareLink);

  (function loadFromHash(){
    if(location.hash && location.hash.startsWith('#data=')){
      try{
        const encoded = location.hash.slice(6);
        const json = LZString.decompressFromEncodedURIComponent(encoded);
        if(json){
          const data = JSON.parse(json);
          applySnapshot(data);
          localStorage.setItem('zippyLastSnapshot', json);
          history.replaceState(null,'',location.pathname);
        }
      }catch(e){ console.error("Share link load failed", e); }
    }
  })();
  </script>
</body>
</html>
